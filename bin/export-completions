#!/usr/bin/python3

import pexpect, time, sys

partial = sys.argv[1]

PROMPT = "PEXPECT_PROMPT> "
# set the partial buffer you want to complete

# spawn interactive bash
child = pexpect.spawn("bash -i", encoding='utf-8', timeout=5)

# set deterministic prompt
child.sendline(f"PS1='{PROMPT}'")
child.expect_exact(PROMPT)

# bind Ctrl-X Ctrl-E to export-completions
child.sendline('bind \'"\\C-x\\C-e": export-completions\'')
child.expect_exact(PROMPT)

# send the partial string into the line editor (no newline)
child.send(partial)

CONTROL_SEQUENCE = '\x18\x05'

# send the control sequence: Ctrl-X (0x18) then Ctrl-E (0x05)
child.send(CONTROL_SEQUENCE)

# give a short moment for readline to print completions
time.sleep(0.05)

# wait for the prompt to reappear so the shell is stable again
child.expect_exact(PROMPT)

# cut first line (partial) and last line (empty) + remove \r
print(child.buffer[len(partial + CONTROL_SEQUENCE + '\n'):-1].replace('\r', ''))

child.sendline("exit")
child.close()
