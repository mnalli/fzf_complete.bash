#!/usr/bin/python3

import pexpect, time, sys

partial = sys.argv[1]

# spawn interactive bash
child = pexpect.spawn("bash -i", encoding='utf-8', timeout=5)

# set prompt
PROMPT = "PEXPECT_PROMPT> "
child.sendline(f"PS1='{PROMPT}'")
child.expect_exact(PROMPT)

# bind export-completions readline function
child.sendline('bind \'"\\C-x\\C-e": export-completions\'')
child.expect_exact(PROMPT)

# send partial string into line editor
child.send(partial)

# send the control sequence: C-x (0x18), C-e (0x05)
CONTROL_SEQUENCE = '\x18\x05'
child.send(CONTROL_SEQUENCE)

# give readline time to print completions
time.sleep(0.05)
child.expect_exact(PROMPT)

# cut first line (partial) and last line (empty) + remove \r
print(child.buffer[len(partial + CONTROL_SEQUENCE + '\n'):-1].replace('\r', ''))

child.sendline("exit")
child.close()
